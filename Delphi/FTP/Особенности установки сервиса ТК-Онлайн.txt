Особенности установки Сервиса ТК-Онлайн.

Служба iaccftp.exe может быть установлена и запущена в нескольких экземплярах.

Стандартный способ инсталяции - в интерфейсе командной строки перейти в директорию, где находится файл iaccftp.exe
и выполнить следующую команду:
iaccftp.exe /install
При этом в списке служб Windows появится запись:

Сервис ТК-онлайн [mpk_service].

К этой службе необходим файл с параметрами  iaccftp.ini.
В файле параметров необходимо указать настройки для приема платежных чеков.

В настоящее время с чеками работают 2 оператора платежей.
По - этому файл iaccftp.ini должен быть сконфигурирован только на прием чеков от 2-х операторов.
В заголовке необходимо проверить следующие параметры и их установленные значения:

ServiceCount=2
PeriodSeconds=60

Соответственно должны быть сконфигурированы разделы [Service.0] и [Service.1].
Разделы конфигурации [Service.2], [Service.3] ( если присутствуют ), необходимо удалить.

Убедитесь, что в разделах [Service.0] и [Service.1] файла iaccftp.ini установлены следующие параметры:

FileMask=TK*.REQ
AnswerMask=TK*.ANS
DeleteFilesAfterImport=2
OverWriteExists=1
DeleteFtpFiles=1
FtpTimeOut=30


----------------------------------------------------------------------------------------------------
По запросам из Личного кабинета операторы таможенных платежей предоставляют информацию  держателям таможенной платежной карты о движении денежных средств на лицевом счете владельца таможенной карты и о расходовании денежных средств, внесенных в качестве авансовых платежей.

В связи с тем, что исполнение запросов из Личного кабинета может занять продолжительное время, 
и на это время операции загрузки чеков будут заблокированы, 
имеется возможность запускать службы получения информации для личного кабинета и загрузки чеков и раздельно.

Второй экземпляр службы необходимо зарегестрировать, запустив из командной строки следующую команду:

iaccftp.exe /install /service_name=iacc_lk /display_name="Сервис ТК-Личный кабинет" /description="Сервис ТК-Личный кабинет"

где
 service_name=iacc_lk - альтернативное системное наименование службы
 display_name="Сервис ТК-Личный кабинет" - имя в списке служб
 description="Сервис ТК-Личный кабинет" - описание службы
 
При успешной регистрации второго экземпляра, в списке служб Windows появится запись "Сервис ТК-Личный кабинет".
Файл параметров для работы с личным кабинетом должен находиться в одной директории с iaccftp.exe.
При этом, имя файла параметров должно совпадать с альтернативным системным наименованием службы
(в данном случае имя будет "iacc_lk.ini").
Структура ini-файла для работы с Личным кабинетом совпадает со структурой ini-файла для службы загрузки чеков по таможенным картам.


И так, после регистрации второго экземпляра службы, в установочной директории должны находяться следующие
файлы:
 iaccftp.exe - исполняемый файл службы Сервис ТК операционной системы Windows.
 iaccftp.ini - файл параметров службы "Сервис ТК - Онлайн", загружающей чеки.
 iacc_lk.ini - файл параметров службы "Сервис ТК - Личный кабинет", генерирующей пользовательские отчеты.


В списке служб операционной системы Windows должны присутствовать записи:
 Сервис ТК-Личный кабинет
 Сервис ТК-онлайн [mpk_service]


После задания параметров в конфигурационных файлах, службы можно запустить,
выбрав действие "Запуск службы" в меню или на инструментальной панели консоли управления службами Windows.


Пример настройки файла параметров для работы с ЛК ( iacc_lk.ini ).

1.Необходимо добавить описание сервисов для работы с личным кабинетом 
участника ВЭД.

Пример описание сервиса взаимодействия с МПС:

Раздел [Common] аналогичен этому же разделу для севиса ТК-Онлайн.
Однако, во избежание путанницы, рекомендуем указывать несовпадающие значения параметров WorkDirPath, LogFileName

[Common]
;путь в рабочий каталог
;здесь необходимо указать путь к общему каталогу, куда производится приём файлов запросов,
;где происходит обработка данных и от куда происходит отправка файлов ответов
WorkDirPath=C:\FTP_LK\

; имя LOG - файла
LogFileName=iacc_lk.log

;максимальный размер LOG - файла, килобайт.
;При превышении этого размера, будет создан новый экземпляр LOG - файла
MaxLogSize=500

;Путь к файлу информации о структуре загружаемых таблиц, необходимой для
;создания файлов ответов при приеме чеков
NsiImportFile=..\..\Bin\nsi_import.ini

;  количество FTP - сервисов с которыми осуществляется взаимодействие
ServiceCount=2

;  интервал опроса ftp - серверов, секунд
PeriodSeconds=90

[DataBase]
; подключение к базе данных
; сервер:
DBName=
; имя пользователя
DBUserName=
; пароль
DBPassword=
; рабочая схема
DBSchema=

; 0 - пароль не зашифрован
; 1 - пароль зашифрован
DBCrypt=0


2. Настройка сервисов

;------ Service.0 ----------------------
[Service.0]
; укажем наименование сервиса
ServiceName=МПС. Личный кабинет.

;Установим служебные папки:
DownLoadDir=MPS_LK\Downloads
ErrorFileDir=MPS_LK\Errors
AnswerDir=MPS_LK\Answers
ArchDownDir=MPS_LK\Arch\Downloads
ArchAnswDir=MPS_LK\Arch\Answers

;Директории на FTP-сервере
SourceDir=IN
DestDir=OUT

;Маска файлов запросов:
FileMask=LS*.req.zip

;Маска файлов ответов:
AnswerMask=LS*.ANS.zip

;В связи с возможностью длительной генерацией ответа, максимальное количество одновременно 
;загружаемых запросов рекомендуется устанавливать в 1 - 3.
MaxTransactionCount = 2

;Рекомендуется данным параметрам присвоить следующие значения:
DeleteFilesAfterImport=2
DeleteOldErrFiles=1
OverWriteExists=1
DeleteFtpFiles=1

[Service.0.FTP]
; Установите верные параметры FTP подключения:
Passive=1
Host=10.88.2.15
Port=21
UserName=m*********
FTPPassword=m*********

; рекомендуемое значение таймаута - половина от интервала опроса в секундах (60 / 2 ):
FtpTimeOut=30

FTPCrpypt=0

[Service.0.PROXY]
ProxyType=0


По аналогии с [Service.0] настроим [Service.1] для взаимодействия с 
оператором Таможенная карта:

;--------- Service.1 -------------------
[Service.1]
ServiceName=TK. Личный кабинет.

DownLoadDir=TK_LK\Downloads
ErrorFileDir=TK_LK\Errors
AnswerDir=TK_LK\Answers
ArchDownDir=TK_LK\Arch\Downloads
ArchAnswDir=TK_LK\Arch\Answers

SourceDir=IN
DestDir=OUT

FileMask=LS*.req.zip
AnswerMask=LS*.ANS.zip

MaxTransactionCount = 2

DeleteFilesAfterImport=2
DeleteOldErrFiles=1
OverWriteExists=1
DeleteFtpFiles=1

[Service.1.FTP]
Passive=1

;Установите верные параметры FTP-соединения:
Host=10.88.2.15
Port=21

UserName=**************
FTPPassword=**************

FtpTimeOut=30
FTPCrpypt=0

[Service.1.PROXY]
ProxyType=0


3. Сохраните созданный ( или отредактированный ) файл iacc_lk.ini и перезапустите службу "Сервис ТК-Личный кабинет".
Через 2-3 минуты просмотрите лог-файл и убедитесь, что сервис функционирует в соответствие с новыми настройками.

Ещё раз обращаем внимание, что выполнение запросов из Личного кабинета может занять продолжительное
время - от нескольких десятков секунд до нескольких десятков минут - в зависимости от производительности 
сервера базы данных и текущей нагрузки.

